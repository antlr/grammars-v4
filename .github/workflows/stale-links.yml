name: Check Stale Links

on:
  schedule:
    # Run every Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      replace:
        description: 'Replace stale links with web.archive.org versions'
        required: false
        default: 'false'
        type: boolean

jobs:
  check-stale-links:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Checkout
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Check for stale links
      id: check-links
      shell: bash
      continue-on-error: true
      run: |
        chmod +x _scripts/find-stale-links.sh
        bash _scripts/find-stale-links.sh --verbose --timeout 15 2>&1 | tee stale-links-report.txt
        echo "exit_code=$?" >> $GITHUB_OUTPUT

    - name: Upload report as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: stale-links-report
        path: stale-links-report.txt
        retention-days: 30

    - name: Create issue if stale links found (scheduled run)
      if: github.event_name == 'schedule' && steps.check-links.outputs.exit_code != '0'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('stale-links-report.txt', 'utf8');

          // Check if there's already an open issue for stale links
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'stale-links',
            per_page: 1
          });

          const title = 'Stale links detected in repository';
          const body = `## Stale Links Report

          The weekly stale links check has detected broken links in the repository.

          <details>
          <summary>Full Report</summary>

          \`\`\`
          ${report}
          \`\`\`

          </details>

          ### Next Steps
          1. Review the stale links listed above
          2. Either update the links to new valid URLs, or
          3. Run the workflow manually with the "Replace" option enabled to automatically replace with web.archive.org versions

          ---
          *This issue was automatically created by the stale-links workflow.*
          `;

          if (issues.data.length > 0) {
            // Update existing issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issues.data[0].number,
              body: `## Updated Stale Links Report (${new Date().toISOString().split('T')[0]})\n\n` + body
            });
            console.log(`Updated existing issue #${issues.data[0].number}`);
          } else {
            // Create new issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['stale-links', 'documentation']
            });
            console.log('Created new stale links issue');
          }

    - name: Replace stale links and create PR (manual trigger with replace=true)
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.replace == 'true'
      shell: bash
      run: |
        chmod +x _scripts/find-stale-links.sh
        bash _scripts/find-stale-links.sh --replace --verbose --timeout 15 || true

    - name: Create Pull Request with fixes
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.replace == 'true'
      uses: peter-evans/create-pull-request@v7
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'fix: replace stale links with web.archive.org versions'
        title: 'fix: Replace stale links with archived versions'
        body: |
          ## Automated Stale Links Fix

          This PR replaces stale/broken links with their web.archive.org archived versions.

          The archived URLs are selected based on the date when each link was originally added to the repository (determined via git blame).

          ### Changes
          - Replaced broken links with corresponding Wayback Machine archived versions

          ---
          *This PR was automatically created by the stale-links workflow.*
        branch: fix/stale-links
        delete-branch: true
        labels: |
          stale-links
          automated-pr
